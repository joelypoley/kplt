\documentclass[10pt]{article}
\usepackage{amsmath,amsthm,amssymb,graphicx,titling,mathrsfs,tikz,tikz-cd}
\usepackage{mathtools}
\usepackage{mleftright}
\usepackage{tikz-cd}
\usepackage{todonotes}
\usepackage{color}
\usepackage{stmaryrd}
\usepackage{hyperref}
\usepackage{pgfplots}

\usepackage{listings}

\lstset{ %
  backgroundcolor=\color{white},   % choose the background color; you must add \usepackage{color} or \usepackage{xcolor}; should come as last argument
  basicstyle=\footnotesize\ttfamily,        % the size of the fonts that are used for the code
  breakatwhitespace=false,         % sets if automatic breaks should only happen at whitespace
  breaklines=true,                 % sets automatic line breaking
  captionpos=b,                    % sets the caption-position to bottom
  commentstyle=\color{mygreen},    % comment style
  deletekeywords={...},            % if you want to delete keywords from the given language
  escapeinside={\%*}{*)},          % if you want to add LaTeX within your code
  extendedchars=true,              % lets you use non-ASCII characters; for 8-bits encodings only, does not work with UTF-8
  frame=single,                    % adds a frame around the code
  keepspaces=true,                 % keeps spaces in text, useful for keeping indentation of code (possibly needs columns=flexible)
  keywordstyle=\color{blue},       % keyword style
  morekeywords={sage},            % if you want to add more keywords to the set
  rulecolor=\color{black},         % if not set, the frame-color may be changed on line-breaks within not-black text (e.g. comments (green here))
  showspaces=false,                % show spaces everywhere adding particular underscores; it overrides 'showstringspaces'
  showstringspaces=false,          % underline spaces within strings only
  showtabs=false,                  % show tabs within strings adding particular underscores
  stepnumber=2,                    % the step between two line-numbers. If it's 1, each line will be numbered
  tabsize=2,                     % sets default tabsize to 2 spaces
  title=\lstname                   % show the filename of files included with \lstinputlisting; also try caption instead of title
}

\usepackage[ruled,vlined]{algorithm2e}

\theoremstyle{plain}
\newtheorem{theorem}{Theorem}[subsection]
\newtheorem{lemma}[theorem]{Lemma}
\newtheorem{corollary}[theorem]{Corollary}
\newtheorem{proposition}[theorem]{Proposition}
\newtheorem{remark}[theorem]{Remark}
\newtheorem{definition}[theorem]{Definition}
\theoremstyle{definition}
\newtheorem{example}[theorem]{Example}
\newtheorem{exercise}[theorem]{Exercise}
\newtheorem{problem}[theorem]{Problem}

\newcommand{\iso}{\cong}
\newcommand{\op}{\operatorname}
\newcommand{\normlin}{\trianglelefteq}
\newcommand{\ideal}{\trianglelefteq}
\newcommand{\N}{\mathbb{N}}
\newcommand{\Z}{\mathbb{Z}}
\newcommand{\Q}{\mathbb{Q}}
\newcommand{\R}{\mathbb{R}}
\newcommand{\C}{\mathbb{C}}
\newcommand{\A}{\mathbb{A}}
\newcommand{\F}{\mathbb{F}}
\newcommand{\HH}{\mathbb{H}}
\newcommand{\p}{\mathfrak{p}}

\newcommand{\cat}[1]{{\normalfont\textbf{#1}}}
\newcommand{\Set}{\cat{Set}}
\newcommand{\Ring}{\cat{Ring}}
\newcommand{\Top}{\cat{Top}}
\newcommand{\Vect}{\cat{Vect}}

\newcommand{\Hom}{\op{Hom}}
\newcommand{\Obj}{\op{Obj}}
\newcommand{\End}{\op{End}}
\newcommand{\Aut}{\op{Aut}}
\newcommand{\nrd}{\op{nrd}}
\newcommand{\trd}{\op{trd}}
\newcommand{\disc}{\op{disc}}
\newcommand{\discrd}{\op{discrd}}
\newcommand{\chr}{\op{char}}
\newcommand{\Frac}{\op{Frac}}
\newcommand{\Pl}{\op{Pl}}
\newcommand{\Ram}{\op{Ram}}
\newcommand{\Cls}{\op{Cls}}
\newcommand{\Gen}{\op{Gen}}
\newcommand{\Typ}{\op{Typ}}
\newcommand{\rk}{\op{rk}}

\newcommand{\defeq}{\vcentcolon=}

\setlength{\droptitle}{-7em}
\title{KPLT Paper}
\author{Joel Laity}

\begin{document}
\maketitle
\tableofcontents

\section{Computing with quaternions}

\begin{definition}[Lattice]
    Let \( B \) be quaternion algebra over \( \Q \).
    A \emph{lattice} in \( B \) is a finitely generated \( \Z \)-submodule \( I \subset B \) with \( I\Q = B \).
\end{definition}

\begin{remark}
    The condition \( I\Q = B \) is equivalent ot saying that \( I \) contains a basis for B as a \( \Q \)-vector space.
\end{remark}

\begin{definition}[Lambda notation for lattices]
    Let \( A \) be a \( n \times k \) rational matrix.
    Define \( \Lambda(A) \subset \Q^n \) to be the \( \Z \)-submodule
    \[
        \Lambda(A) \vcentcolon = \{ Ax \mid x \in \Z^k \}.
    \]
\end{definition}

\begin{definition}[Representing a lattice as a matrix]
    Let \( B \) be quaternion algebra over \( \Q \).
    Let \( I \subset B \) be a lattice in \( B \).
    Let \( \alpha_1, \dots , \alpha_k \in I\) be generators for \( I \) as a \( \Z \)-module.
    Let
    \[
        A =
        \begin{pmatrix}
            [\alpha_1] \\  \vdots \\ [\alpha_k]
        \end{pmatrix}.
    \]
    where \( [\alpha] =  \begin{pmatrix} t, & x, & y, & z, \end{pmatrix} \) is the row of coefficents of \( \alpha = t + xi + yj + zk \).
    Then
    \[
        \Lambda(A) = I.
    \]
    We use \( A \) to represent the lattice \( I \) in a computer.
\end{definition}


\begin{example}
    The following code shows how to take a list of generators of a lattice and turn them into a matrix.
    \begin{lstlisting}
    sage: p = 59
    sage: B.<i,j,k> = QuaternionAlgebra(-1, -p)
    sage: gens = [1/2 + (2/2)*i + (3/2)*j + (4/2)*k, 5/2 + (6/2)*i + (7/2)*j + (8/2)*k]
    sage: from sage.algebras.quatalg.quaternion_algebra import quaternion_algebra_cython
    sage: Z, d = quaternion_algebra_cython.integral_matrix_and_denom_from_rational_quaternions(gens)
    sage: Z
    [1 2 3 4]
    [5 6 7 8]
    sage: d
    2
  \end{lstlisting}
\end{example}

We want to be able to ``row reduce'' a matrix representing a lattice.
To do this we need unimodular matrices.
Unimodular matrices are to lattices as elementary matrices are to vector spaces.

\begin{definition}[Unimodular matrix]
    A \emph{unimodular} matrix is a square integral matrix \( U \in \Z^{n \times n} \) with \( |\det U| = 1 \).
\end{definition}

\begin{lemma}[Properties of unimodular matrices]
    Let \( U \in \Z^{n \times n}\) be a unimodular matrix. Then
    \begin{enumerate}
        \item The inverse \( U^{-1} \) is also unimodular,
        \item \( x \in \Q^n \) is integral if and only if \( Ux \) is integral,
    \end{enumerate}
    If \( A, A' \) are matrices of full rank then
    \[
        A = A'U \text{ for some unimodular \( U \) if and only if } \Lambda(A) = \Lambda(A').
    \]
\end{lemma}
\begin{proof}
    (1) Since \( U \) is integral all its cofactors are integers.
    It follows that its matrix of minors is integral.
    Hence its inverse is integral since \( \det U = \pm 1 \) .
    Finally \( \det U^{-1} = 1 / (\det U) = \pm 1\).

    (2) If \( x \) is integral obviously \( Ux \) is integral.
    If \( Ux \) is integral then \( U^{-1}Ux = x \) is integral.

    For the second part suppose that \( A = A'U \) for some unimodular matrix \( U \).
    Then \( Ax = A'(Ux) \) and \( Ux \) is integral so \( \Lambda(A) \subset \Lambda(A') \).
    Simlarly \( A'x = A(U^{-1}x) \) so \( \Lambda(A) = \Lambda(A') \).

    Suppose that \( \Lambda(A) = \Lambda(A') \).
    Then the columns of \( A \) are in \( \Lambda(A') \) so \( A = A'V \) for some integral matrix \( V \).
    Similarly \( A' = AW \).
    Combining these two equations gives \( A = AWV \) so \( WV  = 1 \) which implies \( \det W \det V = 1 \) hence \( W \) (and \( V \)) is unimodular.
\end{proof}

\begin{definition}[Hermite normal form]
    Let \( A \) be a \( n \times m \) rational matrix.
    The \emph{Hermite normal form} of \( A \) is the unique matrix \( H \) such that there is a unimodular \( n \times n \) matrix \( U \) with \( UA = H \) such that \( H \) satisfies the following conditions
    \begin{enumerate}
        \item \( H \) is upper triangular,
        \item the pivot in each row is the largest element and the entries above it are nonnegative.
    \end{enumerate}
    The hermite normal form always exists.
\end{definition}

Note that \( \Lambda(A) = \Lambda(H) \) by adapting the argument in the above lemma.



\begin{example}
    Given a set of generators for a lattice we can find a set of four generators \( \alpha_1, \dots , \alpha_4 \) such that the matrix
    \[
        A =
        \begin{pmatrix}
            [\alpha_1] \\  \vdots \\ [\alpha_k]
        \end{pmatrix}.
    \]
    is in hermite normal form.
    The following code shows how to take a list of generators, turn them into a matrix, compute the hermite normal form and convert them back.
    \begin{lstlisting}
        sage: B.<i, j, k> = QuaternionAlgebra(-1, -59)
        sage: gens = [i+j, i-j, 2*k, B(1/3), i - k]
        sage:  Z, d = quaternion_algebra_cython.integral_matrix_and_denom_from_rational_quaternions(gens)
        sage: H = Z.hermite_form(include_zero_rows=False)
        sage: quaternion_algebra_cython.rational_quaternions_from_integral_matrix_and_denom(B, H, d)
  \end{lstlisting}
\end{example}

\begin{example}[Applications of HNF]
    You can solve a number of problems with hermite normal form. The results are \href{https://cseweb.ucsd.edu/classes/sp14/cse206A-a/}{here}.
    \begin{description}
        \item[Basis problem] Given a lattice as a matrix \( A \) compute a basis for the lattice (set of \( \Z \)-independent vectors which span the lattice).
        The nonzero rows of the HNF of \( A \) form a basis.
        \item [Equality] Given two lattices as matrices \( A_1, A_2 \) check if \( \Lambda(A_1) = \Lambda(A_2) \).
        To do this you check if \( HNF(A_1) = HNF(A_2) \).
        \item [Union] You find the hermite normal form of \( [A_1 | A_2] \).
        \item [Containment] You check if \( \Lambda(A_1) \cup \Lambda(A_2)  = \Lambda(A_1)\) using the union an equivalence problems above and if they do then \( \Lambda(A_2) \subset \Lambda(A_1) \).
        \item [Membership] Check if \( \Lambda([v]) \subset \Lambda(A) \).
        \item [Intersection] Done using duals.
    \end{description}
\end{example}

\begin{definition}[Order]
    Let \( B \) be quaternion algebra over \( \Q \).
    An \emph{order} \( O \subset B \) is a lattice that is a ring.
    In particular \( 1 \in O \).
\end{definition}

\begin{remark}
    To check if a lattice, represented by a matrix \( A \), is an order we first check if it has full rank, then if \( 1 \in O \) using the membership test from the example above and then check if the basis is multiplicatively closed.
\end{remark}

\begin{definition}[Order of a lattice]
    Let \( B \) be quaternion algebra over \( \Q \).
    Let \( I \subset B  \) be a lattice.
    The \emph{left order} of \( I \) is the set
    \[
        O_L(I) = \{\alpha \in B \mid \alpha I \subset I\}.
    \]
    The \emph{right order} of \( I \) is the set
    \[
        O_R(I) = \{ \alpha \in B \mid I \alpha \subset I \}.
    \]
    These are in fact always orders.
\end{definition}

\begin{remark}
    Let \( B \) be quaternion algebra over \( \Q \).
    Let \( I \subset B  \) be a lattice with basis \( \{ \beta_0, \beta_1, \beta_2, \beta_3 \} \).
    To find the left order of a lattice I we first observe that
    \begin{align*}
        O_L(I)
          & = \{ \alpha \in B \mid \alpha I \subset I \}                                    \\
          & = \{ \alpha \in B \mid \alpha \beta_j \subset I \text{ , for } j = 0, 1, 2, 3\} \\
          & = \bigcap_{j = 0, 1, 2, 3} \{ \alpha \in B \mid \alpha \beta_j  \in I \}        \\
          & = \bigcap_{j = 0, 1, 2, 3} \{ \alpha \in B \mid \alpha  \in I\beta_j^{-1} \}    \\
          & = \bigcap_{j = 0, 1, 2, 3} I\beta_j^{-1}                                        \\
    \end{align*}
    where
    \[
        I\beta_j^{-1}
        \vcentcolon = \{\alpha \beta_j^{-1} \mid \alpha \in I \}
        = \op{span}_\Z\{\beta_0\beta_j^{-1}, \beta_1\beta_j^{-1}, \beta_2\beta_j^{-1}, \beta_3\beta_j^{-1} \}.
    \]
    Note that \( I\beta_j^{-1} \) is a lattice and hence we can calculate \( \bigcap_{j = 0, 1, 2, 3} I\beta_j^{-1}  \) using lattice intersection algorithms.
    The following sage code does this.
    \begin{lstlisting}
        sage: M = [(~b).matrix() for b in self.basis()]
        sage: B = self.basis_matrix()
        sage: invs = [B*m for m in M]
        sage: ISB = [Q(v) for v in intersection_of_row_modules_over_ZZ(invs).row_module(ZZ).basis()]
        sage: O = A.quaternion_order(ISB)
  \end{lstlisting}
\end{remark}

\begin{definition}[Ideal]
    Let \( B \) be quaternion algebra over \( \Q \).
    Let \(O, O' \subset B\) be orders.
    A \textbf{left fractional $O$-ideal} is a lattice $I \subset B$ such that $O \subset O_L(I)$.
    A \textbf{right fractional $O$-ideal} is a lattice $I \subset B$ such that $O \subset O_R(I)$.
    A \textbf{fractional $O, O'$-ideal} is a lattice $I \subset B$ that is both a left fractional $O$-ideal and a right fractional $O'$-ideal.
\end{definition}

\begin{lemma}[Normal ideals are fractional ideals]
    Let \( B \) be quaternion algebra over \( \Q \).
    Let \(O \subset B\) be an order.
    Suppose \( I \subset O \) is an ideal in the usual sense and \( I \) is full (as a lattice).
    Then \( I \) is a left fractional \( O \)-ideal.
\end{lemma}

\begin{definition}[Integral ideals]
    Let \( B \) be quaternion algebra over \( \Q \).
    Let \(O \subset B\) be an order.
    Let \( I  \subset B \) be a left fractional \( O \)-ideal.
    An \emph{integral ideal} \( I  \subset B \) is a left fractional \( O \)-ideal such that \( I \subset O_L(I) \).
    Equivalently, a left fractional \( O \)-ideal \( I  \subset B \) is an integral ideal if \( I \subset O_R(I) \).
\end{definition}

\begin{remark}
    Note that if \( I \subset O \) then \( I \) is immediatly integral since \( O \subset O_L(I) \).
    Any ideal can be made integral by ``clearning denominators''.
    That is, there always exists some \( d \in \Z \) such that \( Id \) is integral.
\end{remark}

\begin{definition}[Norm of an ideal]
    Let \( B \) be quaternion algebra over \( \Q \).
    Let \(O \subset B\) be an order.
    Let \( I  \subset B \) be a left fractional \( O \)-ideal.
    The reduced norm of \( I \) is
    \[
        \nrd(I) = \op{span}_\Z\{ \nrd(\alpha) \mid \alpha \in I\}.
    \]
\end{definition}

\begin{remark}[Why the norm is reduced]
    Let \( B = (a, b | \Q )\).
    So \( i^2 = a \), \( j^2 = b \) and \( ij = k = -ji \).
    Recall that if \( \alpha = t + xi + yj + zk \) then the reduced norm of \( \alpha \) is
    \[
        \nrd(\alpha) = \alpha \overline{\alpha} = t^2 - ax^2 - by^2 + abz^2.
    \]
    There is another obvious way to define the norm and trace of $\alpha \in B$.
    We can embed $B = (a, b \mid F)$ into the endomorphism ring $\End_F(B)$ under the left regular representation
    \begin{align*}
          & B \hookrightarrow \End_F(B) \iso M_4(F)                       \\
          & \alpha \mapsto (\lambda_{\alpha}: \beta \mapsto \alpha \beta)
    \end{align*}
    where $B$ is considered as 4 dimensional $F$-vector space.
    Then we could simply define
    \begin{align*}
        \op{N}(\alpha) = \op{N}([\alpha])
    \end{align*}
    where $\op{N}([\alpha])$ is the norm of the matrix $[\alpha]\in M_4(F) $ corresponding to $\alpha \in B$.
    We can explicitly calculate the matrix \( [\alpha] \)with respect to the basis \( 1, i, j, k \).
    If \( \alpha = t + xi + yj + zk \) then
    \[
        [\alpha] =
        \begin{pmatrix}
            t    & x   & y   & z  \\
            xa   & t   & -za & -y \\
            y    & zb  & t   & x  \\
            -zab & -yb & xa  & t
        \end{pmatrix}
    \]
    Note you can do this in sage like this

    A natural choice for the norm of an element is the determinant of this matrix.
    When you do the calculation you get
    \[
        det([\alpha]) = \nrd(\alpha)^2.
    \]
    This is confirmed with the following calculation
    \begin{lstlisting}
        sage: R.<t, x, y, z, a, b> = PolynomialRing(ZZ)
        sage: A.<i, j, k> = QuaternionAlgebra(a, b)
        sage: alpha = t + x*i + y*j + z*k
        sage: alpha.matrix(action='left')
        [     t      x      y      z]
        [   x*a      t   -z*a     -y]
        [   y*b    z*b      t      x]
        [-z*a*b   -y*b    x*a      t]
        sage: det(alpha.matrix(action='left')) == alpha.reduced_norm()^2
        True
    \end{lstlisting}


\end{remark}

\begin{remark}[Calculating the norm of an ideal]
    {\color{red} I can only prove this works when \( O_L(I) \) is maximal but in Sage and Magma they seem to use this method across the board. I guess the idea idea }
    Calculating norms is far more tricky than what we have done so far.
    Let \( B = (a, b | \Q )\).
    So \( i^2 = a \), \( j^2 = b \) and \( ij = k = -ji \).
    Recall that if \( \alpha = t + xi + yj + zk \) then the reduced norm of \( \alpha \) is
    \[
        \nrd(\alpha) = \alpha \overline{\alpha} = t^2 - ax^2 - by^2 + abz^2.
    \]
    We will now show


    To calculate the norm of an ideal \( I \) with \( O_L(I) \) maximal with  we first define the notion of a \emph{discriminant}.
    Let \( B \) be quaternion algebra over \( \Q \).
    Let \( M \subset B \) be a lattice with basis \( \{\alpha_0, \alpha_1, \alpha_2, \alpha_3,\} \).
    The the discriminant of \( M \) is the determinant of the gram matrix
    \[
        \disc(M) = |\det(\trd(\alpha_i \alpha_j)_{i, j})|.
    \]
    From Lemma 15.4.8 of Voight we know that \( \disc(M) \) is always a square (note to use this lemma we need that \( M \) is projective but this is always true in our case from Corollary 29.28 of Voight).
    We can therefore define \( \op{discrd}(M) = \sqrt(\disc(M)). \)
    We now use the fact that if \( O_L(I) \) is maximal then \( I \) is invertible so by Main Theorem 16.1.3 in Voights book
    \[
        \nrd(I)^2 = [O_L(I) : I].
    \]
    We combine this with Lemma 15.3.8 in Voight which says that
    \[
        \disc(I) = [J : I]^2\disc(J)
    \]
    for any projective lattice \( I, J \subset B \) and we get
    \[
        \nrd(I)^2
        = [O_L(I) : I]
        = \sqrt{\disc(I) / \disc(O_L(I))}
        = \op{discrd}(I) / \op{discrd}(O_L(I)).
    \]
    Taking square roots gives the norm.
    This is how Sage does it.
    Magma computes \( [O_L(I) : I] \) by calculating the determinant of the change of basis matrix from \( I \) to \( O_L(I) \).
    See paragraph 9.6.3 for details.
\end{remark}

\begin{remark}[Ideals of \( M_2(\F_{p^n} \) ]
    Let \( R =  M_2(\F_{p^n}) \).
    Then the proper ideals of \( R \) are all of the form \( I = R\alpha \) where
    \[
        \alpha =
        \begin{pmatrix}
            a & b \\
            0 & 0
        \end{pmatrix}.
    \]
    Hence
    \[
        I = \left\{ \begin{pmatrix}
            c_1a & c_1b \\
            c_2a & c_2b
        \end{pmatrix} \mid c_i \in \F_{p^n} \right\}
    \]

    We now show that all ideals are of this form.
    Let \( I \subset R \) be a left \( R \)-ideal.
    The claim is that both of the rows of the elements \( \alpha \in I \) are of the form \( \begin{pmatrix} c_1a & c_1b\end{pmatrix} \) for some fixed \( a, b \in \F_{p^n} \).
    Suppose that
    \[
        \alpha =  \begin{pmatrix}
            a & b \\
            * & *
        \end{pmatrix}
    \]
    and
    \[
        \beta = \begin{pmatrix}
            c & d \\
            * & *
        \end{pmatrix}
    \]
    where \( (a, b) \) and \( (c, d) \) are linearly independent.
    Then
    \[
        \begin{pmatrix}
            a & b \\
            c & d
        \end{pmatrix} = \alpha + E \beta \in I
    \]
    where \( E \in M_2(\F_{p^n}) \) is the elementary matrix that swaps rows.
    Since \( (a, b) \) and \( (c, d) \) are linearly independent the matrix \( \begin{pmatrix}
        a & b \\
        c & d
    \end{pmatrix} \) is invertible and hence \( I \) contains a unit so \( I = R \).
    It follows that all proper ideals are of this form.

    Moreover \( R \) acts on its left ideals by right multiplication
    \[
        \begin{pmatrix}
            a & b \\
            0 & 0
        \end{pmatrix}
        \begin{pmatrix}
            c_1 & c_2 \\
            c_3 & c_4
        \end{pmatrix}
        =
        \begin{pmatrix}
            ac_1 + bc_3 & ac_2 + bc_4 \\
            0           & 0
        \end{pmatrix}
    \]
    and it's relatively clear this action is transitive for nontrivial proper ideals.

\end{remark}

\begin{lemma}[Ideal of \( M_2(\F_{p^n} \) ]
    There is a bijection
    \[
        \{\text{Ideals of } M_2(\F_{p^n}\} \leftrightarrow \{ \text{Subspace of } \F_{p^n}^2 \}.
    \]
    Given an ideal \( I \subset  M_2(\F_{p^n}\} \) the corresponding subspace is \( \cap_{\alpha \in I} \ker \alpha \) and given a subspace \( W \) the corresponding ideal is \( I = \{\alpha \in M_2(\F_{p^n} \mid W \subset \ker \alpha\} \).

    This implies that all the ideals \( 0 \neq I \subsetneq M_2(\F_{p^n} \) are principle as the correspond tho one dimensional subspaces.
\end{lemma}
\begin{proof}
    TODO.
\end{proof}

\begin{lemma}[Every invertible ideal is of the from \( I = ON + O\alpha \) ]
    Let \( B \) be quaternion algebra over \( \Q \).
    Let \( O \subset B \) be a maximal order.
    Let \( I \subsetneq O \) be a left \( O \)-ideal with prime norm.
    Then \( I = ON + O \alpha \) where \( N = \nrd(I) \) is prime and \( \alpha \in B^* \).
\end{lemma}
\begin{proof}
    {\color{red} Check out exercise 16.5 for why \( I = O(N, \alpha) \) is justified.}
    A proof might go like this.
    Since \( N = \nrd(I) \) we know that \( NO \subset I \).
    Thus from the correspondence theorem \( I / NO \) is an ideal in \( O / NO \).
    The ring \( O / NO \iso M_2(\F_N) \) and the left ideals of \( M_2(\F_N) \) are in correspondence with subspace of \( \F_N^2 \) and all principle.
    Thus \( I / NO \) is generated by a single element \( \alpha \in I / NO \).

    Let \( \beta \in I \).
    Then since \( I \) is principle \( \beta + NO = \gamma_1 \alpha + NO \) for some \( \gamma_1 \in O \).
    Thus \( \beta = \gamma_1\alpha + \gamma_2N \) for some \( \gamma_2 \in O \).
    Thus \( I \subset NO + O\alpha \), since the other inclusion is obvious we have \( I =  NO + O\alpha \).
\end{proof}

{\color{red} Given a \( \Z \)-basis for \( I \) how would you find \( \alpha \) in the above lemma?}

\section{KPLT paper in special case}
\subsection{Description of special case}
We will now go through the KPLT paper.

Theorem 9 of the paper says that if you can solve the ideal isogeny problem for a maximal order \( O \subset B_{p, \infty} \) then you can solve it for any  maximal order.


We will focus on the quaternion algebra with discriminant \( p \equiv 3 \pmod{4} \).
This quaternion algebra can be written as
\[
    B = (-1, -p \, \mid \, \Q).
\]
The case \( p \equiv 1 \pmod{4} \) is similar, but more annoying.

Since we can choose to solve the isogeny problem for any maximal order we will assume
\[
    O = \Z \langle i, (1+j) / 2 \rangle = \op{span}_\Z \{ (1+j) / 2, (i+k) / 2 , j, k \}.
\]
Note that \( \{ (1+j) / 2, (i+k) / 2 , j, k \} \) is a \( \Z \)-basis for \( O \) in Hermite normal form.

We state the problem we are trying to solve formally.

\begin{problem} \label{prob: general}
Let \( p \equiv 3 \pmod{4} \).
Let \( B =  (-1, -p \, \mid \, \Q) \) be a quaternion algebra.
Let \( O = \Z \langle i, (1+j) / 2 \).
Let \( I \subset O \) be a left \( O \)-ideal ideal.
Given a prime \( \ell \), \( p \) and a basis for \( I \) find a basis for a left \( O \)-ideal \( J \) such that \( J \) has \( \ell \)-power norm.
\end{problem}

\begin{lemma}[Properties of \( (-1, -p \, \mid \, \Q) \)]
    Let \( p \equiv 3 \pmod{4} \).
    Let \( B =  (-1, -p \, \mid \, \Q) \) be a quaternion algebra.
    Then the multiplication table for \( B \) is
    \[
        \begin{array}{c|ccc}
              & i  & j   & k  \\
            \hline
            i & -1 & k   & -j \\
            j & -k & -p  & pi \\
            k & j  & -pi & -p
        \end{array}
    \]

    The norm equation for \( B \) is
    \[
        \nrd(t + xi + yj + zk) = t^2 + x^2 + y^2p + z^2p.
    \]
    The trace equation for \( B \) is
    \[
        \trd(t + xi + yj + zk) = 2t.
    \]
\end{lemma}
\begin{proof}
    We verify with Sage.
    \begin{lstlisting}
        sage: A.<t, x, y, z, p> = PolynomialRing(QQ)
        sage: B.<i, j, k> = QuaternionAlgebra(-1, -p)
        sage: matrix([[a * b for b in [i, j, k]]
                       for a in [i, j, k]])
        [    -1      k     -j]
        [    -k     -p    p*i]
        [     j (-p)*i     -p]
        sage: alpha = t + x*i + y*j + z*k
        sage: alpha.reduced_norm()
        y^2*p + z^2*p + t^2 + x^2
        sage: alpha.reduced_trace()
        2*t
    \end{lstlisting}
\end{proof}

\begin{lemma}[]
    Let \( p \equiv 3 \pmod{4} \).
    Let \( B =  (-1, -p \, \mid \, \Q) \) be a quaternion algebra.
    Then \( \disc B = p \).
\end{lemma}
\begin{proof}
    (Sketch.)
    The discriminant of \( B \) is the product of the primes where \( B \) is ramified.
    Apparently?? \( B \) can only be ramified at primes dividing its invariants (\( a, b = -1, -p\)).
    Calculations with hilbert symbols then shows that \( \disc B = p \)
\end{proof}

\begin{lemma}[Maximal order in \( B_{p, \infty} \) where \( p \equiv 3 \pmod{4} \)]
    Let \( p \equiv 3 \pmod{4} \).
    Let \( B =  (-1, -p \, \mid \, \Q) \) be a quaternion algebra.
    Let \( O = \Z \langle i, (1+j) / 2 \).
    Then \( O \) is a maximal order.
\end{lemma}
\begin{proof}
    Check that \( \disc O  = p = \disc B\).
\end{proof}

\begin{example}
    Our running example will have \( p = 59 \).
    \begin{lstlisting}
        sage: p = 59
        sage: p.mod(4) == 3
        True 
        sage: B.<i, j, k> = QuaternionAlgebra(-1, -p)
        sage: B.discriminant() == p
        True
        sage: B.maximal_order()
        Order of Quaternion Algebra (-1, -59) with base ring Rational Field with basis (1/2 + 1/2*j, 1/2*i + 1/2*k, j, k)
        sage: # We now verify B.maximal_order() is maximal.
        sage: B.maximal_order().discriminant() == B.discriminant()
        True
    \end{lstlisting}
\end{example}

\begin{remark}
    We will now define a ``distinguished quadratic subring'' of \( O \).
    This subring may be slightly different if \( p \not\equiv 3 \pmod{4} \).
\end{remark}

\begin{lemma}[Distinguished quadratice subring]
    Let \( p \equiv 3 \pmod{4} \).
    Let \( B =  (-1, -p \, \mid \, \Q) \) be a quaternion algebra.
    Let \( O = \Z \langle i, (1+j) / 2 \).
    Let \( R = \Z[i] \subset O \).
    Then \( R \) has discriminant \( D = 4 \), \( R^\perp = Rj \) and \( R + Rj = \Z\langle i, j \rangle\) is a suborder of \( O \) of index \( D \).
    Moreover
    \[
        \nrd(t + xi + (y + zi)j) = f(t, x) + p f(y, z)
    \]
    where \( f(t, x) = t^2 + x^2 \) is a principal quadratic form of discriminant \( D \).
\end{lemma}
\begin{proof}
    Note that it seems they are not normalizing their discriminants by \( 2^{-n} \) which is the usual thing to do.
    Hence the discriminant of \( f \) is 4 as required by the lemma.
    The discriminant is equal to the index since \( O \) is maximal so \( O = O_L(R) \).
\end{proof}

\subsection{High level overview}

We first describe the special case of the problem we are trying to solve.
\begin{problem}
Let \( p \equiv 3 \pmod{4} \).
Let \( B =  (-1, -p \, \mid \, \Q) \) be a quaternion algebra.
Let \( O = \Z \langle i, (1+j) / 2 \).
Let \( R = \Z \langle i , j \rangle \).
Given a basis for a left \( O \)-ideal \( I \subset O \) and a prime number \( \ell \), find a basis for another left \( O \)-ideal \( J \subset O \) such that \( I \) and \( J \) are in the same class and \( \nrd(J) \) is a power of \( \ell \).
\end{problem}

If \( p \equiv 1 \pmod{4} \) then \( B \), \( O \) and \( R \) will be different as described in Section 2.3 of the paper.

We will solve this problem like this:
\begin{enumerate}
    \item
          Replace \( I \) with an ideal in the same class but with reduced norm \( N \) where \( N \) is a large prime, coprime to \( \ell \), \( |\disc R| \) and \( p \).
    \item Find \( \alpha \in I \) such that \( I = ON + O\alpha \).
    \item
          Find a \( \gamma \in O \) with \[ \nrd(\gamma) = N \ell^{e_0} \] for some \( e_0 \in \N \).
    \item
          Find \( \mu \in Rj \subset  O \) such that \[ \gamma\mu \equiv \alpha \mod NO \] and \( \nrd(\mu) \not\equiv 0 \pmod{N} \).
    \item
          Find \( \mu' \in  O \) and \( \lambda \in \Z \) such that \[ \mu' \equiv \lambda \mu \mod NO \] and \[ \nrd(\mu') = \ell^{e_1} \] and \( (\lambda, N) = 1 \).
    \item
          Set \( \beta = \gamma \mu' = \lambda\gamma\mu \equiv \lambda \alpha \pmod{NO} \). %Then \( \beta \in I \) and \( \nrd(\beta) = \nrd(\gamma)\nrd(\mu') = N\ell^{e_0 + e_1}\).
    \item
          Finally \[ J \vcentcolon = I\overline{\beta}/N \] is an ideal in the same class with \( J \subset O \) and \( \nrd(J) \) is a power of \( \ell \).
\end{enumerate}

We first show that the output is correct, we will then show how to complete each of the steps.

\subsection{Proof the output is correct}
We will use the following two lemmas.
\begin{lemma}[Finding an equivalent ideal]
    Let \( p \equiv 3 \pmod{4} \).
    Let \( B =  (-1, -p \, \mid \, \Q) \) be a quaternion algebra.
    Let \( O = \Z \langle i, (1+j) / 2 \).
    Let \( I \) be a left \( O \)-ideal of reduced norm \( N \).
    Let \( \alpha \in I \).
    Let \( \gamma = \overline{\alpha} / N \).
    Then \( I \gamma \) is a left, non-fractional \( O \)-ideal of norm \( \nrd(\alpha) / N \).
\end{lemma}
\begin{proof}
    \[
        \nrd(I \gamma) = \nrd(I)\nrd(\gamma) = N \nrd(\alpha) / N^2 = \nrd(\alpha) / N.
    \]
    It remains to show that \( I\gamma \subset O \).
    We have
    \[
        I\gamma = I\overline{\alpha} / N \subset I\overline{I} \frac{1}{N} = NO \frac{1}{N} = O.
    \]
\end{proof}

\begin{lemma}
    Let \( p \equiv 3 \pmod{4} \).
    Let \( B =  (-1, -p \, \mid \, \Q) \) be a quaternion algebra.
    Let \( O = \Z \langle i, (1+j) / 2 \).
    Let \( \alpha \in O \).
    Let \( N \) be prime.
    Let \( I = ON + O\alpha \) be a left \( O \)-ideal with norm \( N \).
    Suppose
    \[
        \beta \equiv \lambda \alpha \pmod{NO}
    \]
    where \( (lambda, N) = 1 \).
    Then
    \[
        \beta \in I.
    \]
\end{lemma}
\begin{proof}
    We prove the stronger condition that \( I = ON + O\beta \).
    We have
    \[
        ON + O\alpha
        = ON + O(\lambda^{-1} \bmod{N}\beta)
        \subset ON + O\beta .
    \]
    and
    \[
        ON + O\beta
        = ON + O\lambda \alpha
        \subset ON + O\alpha .
    \]
\end{proof}

We can now prove the correctness.
Let \( \beta \) be as in step 6.
Then \( \beta \in I \) from Lemma ?? and \( \nrd(\beta) = \nrd(\gamma) \nrd(\mu') = N\ell^{e_0 + e_1} \).
Now from Lemma ?? \( I\overline{\beta}/N \) has norm \( \nrd(\beta) / N = \ell^{e_0 + e_1} \).

\subsection{Step 1}
\subsection{Step 2}
\subsection{Step 3}
\subsection{Step 4}
\subsection{Step 5}




\begin{example}
    We do a sanity check of the previous lemma.
    \begin{lstlisting}
        sage: p = 59
        sage: B.<i, j, k> = QuaternionAlgebra(-1, -p)
        sage: O = B.maximal_order()
        sage: I = O.left_ideal(O.basis()).scale(2)
        sage: alpha = sum(ZZ.random_element(10) * x for x in I.basis())
        sage: N = I.norm()
        sage: I.scale(alpha.conjugate() / N).norm() == alpha.reduced_norm() / N
        True
    \end{lstlisting}
\end{example}

\begin{example}
    Given a left \( O \)-ideal \( I \) we show how to compute another ideal \( J \subset O \) in the same class but with prime norm.
    Generate a random element \( \alpha \in I \) by taking random linear combination of the basis elements where the coefficients are bounded by some bound \( m \).
    If \( \nrd(\alpha) = NM \), where \( M \) is prime then return \( J = I \overline{\alpha} / N \), else pick another random element an continue.
\end{example}


\begin{example}
    Given \( O = \Z \langle i, (1+j) / 2 \) and an integer \( M \) we show how to find \( \gamma \in O \) such that \( \nrd(\gamma) = M \).

    First choose \( (y, z) \in [-m , m]^2 \) at random until \( r = M - pf(y, z) = M - py^2 - pz^2\) is prime.
    Then use Cornaccia's algorithm to find \( t, x \in \Z \) such that \(  t^2 + x^2 = r.\)
    Finally \( \nrd(t + xi + yj + zk) = t^2 + x^2 + py^2 + pz^2 = r + py^2 + pz^2 = M - py^2 - pz^2 py^2 + pz^2 = M\).
    Moreover \( t + xi + yj + zk \in O \) because \( t, x, y, z \in \Z \) and \( \Z \langle i ,j, k \rangle \subset O \).
\end{example}


So far we have reduced Problem \ref{prob: general} to the following problem.
\begin{problem} \label{prob: prime norm}
Let \( p \equiv 3 \pmod{4} \).
Let \( B =  (-1, -p \, \mid \, \Q) \) be a quaternion algebra.
Let \( O = \Z \langle i, (1+j) / 2 \).
Let \( I \subset O \) be an ideal with prime norm \( N \).
We further assume \( N \) is large and coprime to \( \ell \), 4 and \( p \).
Given a prime \( \ell \), \( p \), a basis for \( O \) and a basis for \( I \) find a basis for a left \( O \)-ideal \( J \) such that \( J \) has \( \ell \)-power norm.
\end{problem}

This is equivalent to the following problem, although I'm not sure what the most elegant proof is.
\begin{problem} \label{prob: prime norm}
Let \( p \equiv 3 \pmod{4} \).
Let \( B =  (-1, -p \, \mid \, \Q) \) be a quaternion algebra.
Let \( O = \Z \langle i, (1+j) / 2 \).
Let \( I \subset O \) be an ideal with prime norm \( N \).
We further assume \( N \) is large and coprime to \( \ell \), 4 and \( p \).
Given a prime \( \ell \), \( p \), a basis for \( O \), \( N \) and \( \alpha \in I \) such that \( I = ON + O\alpha \) find a basis for a left \( O \)-ideal \( J \) such that \( J \) has \( \ell \)-power norm.
\end{problem}

This problem can then be reduced using Lemma ??

\begin{problem} \label{prob: ell power}
Let \( p \equiv 3 \pmod{4} \).
Let \( B =  (-1, -p \, \mid \, \Q) \) be a quaternion algebra.
Let \( O = \Z \langle i, (1+j) / 2 \).
Let \( I \subset O \) be an ideal with prime norm \( N \).
We further assume \( N \) is large and coprime to \( \ell \), 4 and \( p \).
Given a prime \( \ell \), \( p \), a basis for \( O \), \( N \) and \( \alpha \in I \) such that \( I = ON + O\alpha \) find \( \beta \in I \) such that \( \nrd(\beta) = N\ell^e \) for some \( e \in \N \).
\end{problem}


The previous lemma reduces the problem further.

\begin{problem} \label{prob: solve congruence}
Let \( p \equiv 3 \pmod{4} \).
Let \( B =  (-1, -p \, \mid \, \Q) \) be a quaternion algebra.
Let \( O = \Z \langle i, (1+j) / 2 \).
Let \( I \subset O \) be an ideal with prime norm \( N \).
We further assume \( N \) is large and coprime to \( \ell \), 4 and \( p \).
Given a prime \( \ell \), \( p \), a basis for \( O \), \( N \) and \( \alpha \in I \) such that \( I = ON + O\alpha \), find \( \beta \in I \) such that
\[
    \beta \equiv \lambda \alpha \pmod{NO}
\]
where \(\lambda \) is coprime to \( N \) and
\[
    \nrd(\beta) = N\ell^e
\]
for some \( e \in \N \).
\end{problem}

We can now solve the problem like this
\begin{enumerate}
    \item
          Find a random \( \gamma \in O \) with \( \nrd(\gamma) = N \ell^e_0 \) using Lemma ??
    \item
          Find \( \mu \in Rj \subset  O \) such that \( \gamma\mu \equiv \alpha \mod NO \) using linear algebra.
    \item
          Find \( \mu' \in  O \) and \( \lambda \in \Z \) such that \( \mu' \equiv \lambda \mu \mod NO \) and \( \nrd(\mu') = \ell^{e_1} \) and \( (\lambda, N) = 1 \) using techniques yet to be described.
    \item
          Set \( \beta = \gamma \mu' = \lambda\gamma\mu \equiv \lambda \alpha \pmod{NO} \). Then \( \nrd(\beta) = \nrd(\gamma)\nrd(\mu') = N\ell^{e_0 + e_1}\) and \( \beta \equiv \lambda \alpha \pmod{NO} \) as required.
\end{enumerate}

\section{Step 2}

We will now show how to solve step 2.

The first observation is that instead of working over \( O / NO \) we can work over \( (R+Rj) / N(R+Rj) = \Z \langle i, j \rangle \).

\begin{lemma}[\( R/ NR \iso S / NS \) ]
    Let \( R \) be a ring.
    Let \( S \subset R \) be a subring.
    Let \( M = [R : S] \) where the index is as abelian groups.
    Let \( N \in \N \) be coprime to \( M \).
    Then
    \[
        R / NR \iso S / NS.
    \]
\end{lemma}
\begin{proof}
    See \href{https://math.stackexchange.com/questions/387931/fracsms-is-isomorphic-to-fracrmr-where-m-is-coprime-to-n}{this} question.
\end{proof}

\begin{corollary}[\( O / NO \iso (R + Rj) / N(R + Rj)\)]
    Let \( p \equiv 3 \pmod{4} \).
    Let \( B =  (-1, -p \, \mid \, \Q) \) be a quaternion algebra.
    Let \( O = \Z \langle i, (1+j) / 2 \).
    Let \( R = \Z[i] \).
    Let \( N \) be a prime not dividing \( [O : R + Rj] \).
    Then
    \[
        O / NO \iso (R + Rj) / N(R + Rj) = \Z \langle i, j \rangle / N \Z \langle i, j \rangle \iso M_2(\Z / N\Z.
    \]
\end{corollary}
\begin{proof}
    The first isomorphism follows directly from the corollary.
    The isomorphism follows from the fact that \( \Z \langle i, j \rangle / N \Z \langle i, j \rangle \) is a quaternion algebra over the finite field \( \Z / N \Z \), i.e. \( \Z \langle i, j \rangle / N \Z \langle i, j \rangle = (-1, -p \, | \, \Z / N \Z ) \).
    Every quaternion algebra over a finite field is split hence \( \Z \langle i, j \rangle / N \Z \langle i, j \rangle \iso M_2(\Z / N \Z) \).
\end{proof}

\begin{example}
    The isomorphism
    \[
        O / NO \iso (-1, -p \, | \, \Z / N\Z)
    \]
    can be computed explicitly by unpacking all the proofs.
    Find \( a, b \in \Z \) such that
    \[
        Da + Nb = 1
    \]
    where \( D = [O : R + Rj] \).
    Then
    \[
        x + NO \mapsto Dax + NS
    \]
    is the isomorphism.
\end{example}

We have therefore reduced the problem to this.

\begin{problem}
Given \( \gamma, \alpha \in (-1, -p \, | \, \Z / N\Z) \) find \( \mu \in \Z j + \Z k \subset (-1, -p \, | \, \Z / N\Z) \) such that
\[
    \gamma \mu = \alpha .
\]
\end{problem}

This can be solved by finding the left action matrix of \( \gamma \) and solving a system of linear equations.

\begin{example}
    -
    \begin{lstlisting}
        sage: F = GF(101)
        sage: B.<i, j, k> = QuaternionAlgebra(F, -1, -p)
        sage: gamma = 16 + 59*i
        sage: alpha = 10*j - k
        sage: alpha_vec = matrix(F, alpha.coefficient_tuple())
        sage: gamma_mat = gamma.matrix(action='left')
        sage: # Ensure our solution is in Rj
        sage: gamma_mat = matrix(F, [gamma_mat[2], gamma_mat[3]])
        sage: sol = gamma_mat.solve_left(alpha_vec)
        sage: y, z = [sol[0][i] for i in [0, 1]]
        sage: mu = y*j + z*k
        sage: gamma * mu == alpha
        True
    \end{lstlisting}
\end{example}

\begin{remark}
    A natural question is does a solution always exist to
    \[
        \gamma \mu = \alpha .
    \]
    We note that \( \gamma \) and \( \alpha \) generate nontrivial, proper ideals so \( \gamma, \alpha \) are nonzero and are nonunits.
    We can look at the nonzero non units in \( M_2(\Z / N\Z) \) which are all of the form
    \[
        \begin{pmatrix}
            ax + ay \\
            bx + by
        \end{pmatrix}
    \]
    By doing elementary row operations (which can be ``absorbed'' by \( \mu \)) we see that the question is equivalent to finding a solution to
    \[
        \Gamma M = A
    \]
    where \( \Gamma \) and \( A \) are of the form
    \[
        \begin{pmatrix}
            * & * \\
            0 & 0
        \end{pmatrix}
    \]
    You can verify by hand that such a \( M \) always exists.
\end{remark}


\section{Step 3}

We have therefore reduced the problem to this.
\begin{problem}
Let \( p \equiv 3 \pmod{4} \).
Let \( B =  (-1, -p \, \mid \, \Q) \) be a quaternion algebra.
Let \( O = \Z \langle i, (1+j) / 2 \).
Let \( R = \Z[i] \).
Let \( N \) be prime.
Given \( \mu \in Rj \) find \( \mu' \in O \) and \(\lambda \in \Z \) such that
\[
    \mu' \equiv \lambda \mu \pmod{NO}
\]
where \( (\lambda, N) = 1 \) and
\[
    \nrd(\mu') = \ell^{e_1}
\]
for some \( e_1 \in \N \).
\end{problem}

\begin{example}
    We will now show how to solve this problem.
    As input we are given a prime \( p \equiv 3 \pmod{4} \), \( \mu_0 = \beta_0j \in (R / NR)^*[j] \), and a prime \( N \neq p \) sufficiently large.
    The goal is to find \( \lambda \in \Z \) coprime to \( N \) and \( \mu_1 \in  R + Rj \) such that \( \mu \vcentcolon = \lambda \mu_0 + N \mu_1 \) has \( \ell \) power norm
    \[
        \ell^e = \nrd(\mu).
    \]

    Write \( \mu_1 = \alpha_1 + \beta_1j \) where \( \alpha_1, \beta_1 \in \Z[i] \).
    Then
    \begin{align*}
        \ell^e
          & = \nrd(\mu)                                                                                                      \\
          & = \nrd(\lambda \mu_0 + N \mu_1)                                                                                  \\
          & = \nrd(N\alpha_1 + (\lambda\beta_0 + N\beta_1)j)                                                                 \\
          & = \nrd(N\alpha_1) +p\nrd(\lambda\beta_0 + N\beta_1)                                                              \\
          & = \nrd(N\alpha_1) + p\trd(\lambda \beta_0\overline{N\beta_1}) + p\nrd(\lambda\beta_0) + p\nrd(N\beta_1)          \\
          & = N^2\nrd(\alpha_1) +  p\lambda N \trd(\beta_0\overline{\beta_1}) + p\lambda^2 \nrd(\beta_0) + pN^2\nrd(\beta_1) \\
          & = p\lambda^2 \nrd(\beta_0) + Np\lambda \trd(\beta_0\overline{\beta_1}) + N^2(p\nrd(\beta_1) + \nrd(\alpha_1))
    \end{align*}
    Note that we are given all variables with subscript 0 and are solving for the variables of subscript 1.
    Reducing modulo \( N \) gives
    \[
        \ell^e \equiv p\lambda^2\nrd(\beta_0) \pmod{N}.
    \]
    We then choose \( e \) to be even if \( p(z_0^2 + w_0^2))^{-1} \bmod{N} \) is a square modulo \( N \) and odd otherwise.
    This ensures that \( \ell^e(p(z_0^2 + w_0^2))^{-1} \) is a square modulo \( N \) and we can solve for \( 0 <  \lambda < N\).
    We also choose \( e \) sufficiently large (\( \ell^e >> p|D|N^4 \)).
    Reducing modulo \( N^2 \) gives
    \[
        \frac{\ell^e - p\lambda^2\nrd(\beta_0)}{N}\equiv p\lambda \trd(\beta_0\overline{\beta_1}) \pmod{N^2}
    \]
    which is a linear equation in the coefficients of \( \beta_1 \in \Z[i]\).
    There will be \( N \) solutions to this equation and we a solution randomly such that \( \nrd(\lambda\beta_0 + N\beta_1) < N^4 \).

    The only variable left that hasn't be determined is \( \alpha_1 \) so rearranging gives
    \[
        \nrd(\alpha_1) = \frac{\ell^e - p\lambda^2 \nrd(\beta_0) - Np\lambda \trd(\beta_0\overline{\beta_1})}{N^2}.
    \]
    The integer \( e \) was chosen sufficiently large so that the right hand side is positive.

    It is possible that no solution for \( \alpha_1 \) exists.
    If this is the case then we choose a different \( \beta_1 \) from the previous step and repeat.
    Under the assumption that the right hand side of the above equation behaves like random values around \( N^4|D|p \) as we change \( \beta_1 \) we will find a solution in polynomial time.
\end{example}

\begin{lemma}[\( \nrd(\alpha_1 + \alpha_2) - \nrd(\alpha_1) - \nrd(\alpha_2) = \trd(\alpha_1 \overline{\alpha_2}) \)]
    \[
        \nrd(\alpha_1 + \alpha_2) - \nrd(\alpha_1) - \nrd(\alpha_2) = \trd(\alpha_1 \overline{\alpha_2})
    \]
\end{lemma}
\begin{proof}
    -
    \begin{lstlisting}
        sage: A.<t_1, x_1, y_1, z_1, t_2, x_2, y_2, z_2, a, b> = PolynomialRing(QQ)
        sage: B.<i, j, k> = QuaternionAlgebra(a, b)
        sage: alpha_1 = t_1 + x_1 *i + y_1 * j + z_1 * k
        sage: alpha_2 = t_2 + x_2 *i + y_2 * j + z_2 * k
        sage: (alpha_1 + alpha_2).reduced_norm() - alpha_1.reduced_norm() - alpha_2.reduced_norm() == (alpha_1 * alpha_2.conjugate()).reduced_trace()
        True
    \end{lstlisting}
\end{proof}





\end{document}




































